<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impact Reversal Training by Sound</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .impact-button {
            width: 100%;
            height: 300px;
            font-size: 2rem;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Drive Impact Reversal Training by Sound v1.29</h1>

        <!-- çŠ¶æ…‹1: åˆæœŸç”»é¢ -->
        <div id="state1">
            <h2>ãŠã˜æ•™æˆã®éŸ³å£°ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆè¿”ã—ç‰¹è¨“ã‚¢ãƒ—ãƒª</h2>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="fakeModeCheckbox">
                <label class="form-check-label" for="fakeModeCheckbox">
                    ãƒ•ã‚§ã‚¤ã‚¯ã‚ã‚Š / With Fakes
                </label>
            </div>
            <button id="startButton" class="btn btn-primary impact-button">start</button>
            <div class="mt-4 p-3 bg-light rounded">
                <h5 class="mb-3">ä½¿ç”¨æ–¹æ³• / How to Use</h5>
                <ul>
                    <li>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚„PCã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œã—ã¾ã™ã€‚ / Works on smartphone and PC browsers.</li>
                    <li>ãƒ•ã‚§ã‚¤ã‚¯ã‚ã‚Šãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆéŸ³ã®ä»–ã«ãƒ•ã‚§ã‚¤ã‚¯éŸ³ãŒãƒ©ãƒ³ãƒ€ãƒ ã«å†ç”Ÿã•ã‚Œã‚‹ã®ã§ã€æ°—ã‚’ã¤ã‘ã¾ã—ã‚‡ã†ã€‚ / In "With Fakes" mode, be careful as fake sounds are randomly played in addition to the Drive Impact sound.</li>
                    <li>ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆè¿”ã—ã®çŒ¶äºˆã¯ã€å…¥åŠ›é…å»¶ã®2ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’åŠ å‘³ã—ã¦25ãƒ•ãƒ¬ãƒ¼ãƒ æœªæº€ã§ã™ã€‚ / The Drive Impact reversal window is less than 25 frames, considering 2 frames of input lag.</li>
                    <li>PCã‚„ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ï¼ˆiOSã¯æœªå¯¾å¿œï¼‰ã«ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã‚’USBæ¥ç¶šã™ã‚Œã°ã€ä»»æ„ã®ãƒœã‚¿ãƒ³ã§ä½¿ç”¨ã§ãã¾ã™ã€‚ / You can use any button if you connect a game controller via USB to your PC or smartphone (except iOS).</li>
                    <li>BGMã‚’é³´ã‚‰ã—ãªãŒã‚‰ä½¿ã£ãŸã‚Šã€æ˜ ç”»ã‚’è¦‹ãªãŒã‚‰ä½¿ã£ãŸã‚Šã€ã„ã¤ã§ã‚‚ç·´ç¿’ã—ã¦ãã ã•ã„ã€‚ / Practice anytime, even while listening to BGM or watching movies.</li>
                    <li>â€»éŸ³ã®å†ç”Ÿé–‹å§‹ã‹ã‚‰è¨ˆæ¸¬ã—ã¦ã„ã‚‹ã®ã§ã€å®Ÿéš›ã®æˆåŠŸåˆ¤å®šã¨ã¯ç•°ãªã‚Šã¾ã™ã€‚/ Note: The measurement starts from the sound playback start, so it is different from the actual success determination.</li>
                    <li>Special thanks to <a href="https://twitter.com/naruxu_sf" target="_blank" rel="noopener noreferrer">@naruxu_sf</a>ğŸ˜Š</li>
                </ul>
            </div>
            </div>

        <!-- çŠ¶æ…‹2: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”»é¢ -->
        <div id="state2" style="display: none;">
            <p>ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã®éŸ³ãŒé³´ã£ãŸã‚‰ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä¸‹ã•ã„ã€‚ / Push the button when the drive impact sound is played.</p>
            <button id="impactButton" class="btn btn-danger impact-button">ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãƒœã‚¿ãƒ³ / Impact button</button>
        </div>

        <!-- çŠ¶æ…‹3: çµæœç”»é¢ -->
        <div id="state3" style="display: none;">
            <h3>çµæœ</h3>
            <div id="resultText">
                <p>çµŒéæ™‚é–“ / Elapsed Time: <span id="resultTimeMs"></span> ms</p>
                <p>ãƒ•ãƒ¬ãƒ¼ãƒ  / Frames: <span id="resultTimeFrames"></span> frames (60fps)</p>
            </div>
            <h4 id="resultMessage" class="mt-3"></h4>
            <button id="retryButton" class="btn btn-primary mt-3">ã‚‚ã†ä¸€åº¦ã‚„ã‚‹</button>
            <a id="tweetButton" href="#" class="btn btn-info mt-3" target="_blank" style="display: none;">Xã§çµæœã‚’å…±æœ‰</a>
        </div>
    </div>

    

    <script>
        const state1 = document.getElementById('state1');
        const state2 = document.getElementById('state2');
        const state3 = document.getElementById('state3');

        const startButton = document.getElementById('startButton');
        const impactButton = document.getElementById('impactButton');
        const retryButton = document.getElementById('retryButton');

        const resultTimeMs = document.getElementById('resultTimeMs');
        const resultTimeFrames = document.getElementById('resultTimeFrames');
        const resultText = document.getElementById('resultText');
        const resultMessage = document.getElementById('resultMessage');
        const tweetButton = document.getElementById('tweetButton');
        const fakeModeCheckbox = document.getElementById('fakeModeCheckbox');

        let startTime;
        let timer;
        let timeoutTimer; // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç›£è¦–ç”¨ã®ã‚¿ã‚¤ãƒãƒ¼
        let currentMode = 'normal'; // 'normal' or 'fake'
        let activeAudioSource = null; // å†ç”Ÿä¸­ã®éŸ³æºã‚’ç®¡ç†
        let trainingStatus = 'idle'; // 'idle', 'waiting', 'playing'
        let prevGamepadButtons = {};

        // Web Audio APIã®æº–å‚™
        let audioContext;
        let audioBuffer; // B.wavç”¨
        let sf6ImpactSoundBuffer; // SF6Impact.wavç”¨
        let flyingAudioBuffer; // ãƒ•ãƒ©ã‚¤ãƒ³ã‚°ç”¨ã®éŸ³å£°ãƒãƒƒãƒ•ã‚¡
        let state2EntrySoundBuffer; // çŠ¶æ…‹2ç§»è¡Œæ™‚ç”¨ã®éŸ³å£°ãƒãƒƒãƒ•ã‚¡
        let fakeAudioBuffers = [];

        let useOldImpactSound = false; // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§o=1ãŒæŒ‡å®šã•ã‚ŒãŸã‚‰true

        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãƒ‡ã‚³ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
        async function setupAudio() {
            if (audioBuffer && sf6ImpactSoundBuffer && flyingAudioBuffer && fakeAudioBuffers.length > 0 && state2EntrySoundBuffer) return true;

            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error('Web Audio API is not supported in this browser');
                    alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
                    return false;
                }
            }

            startButton.disabled = true;
            startButton.textContent = 'Loading...';
            try {
                const listResponse = await fetch('fakes_list.json');
                const fakeSoundFilenames = await listResponse.json();
                const fakeSoundPaths = fakeSoundFilenames.map(file => `fakes/${file}`);

                const responses = await Promise.all([
                    fetch('B.wav'),
                    fetch('SF6Impact.wav'),
                    fetch('sfxg_beep_fast.mp3'),
                    fetch('computer-find_mono.mp3'),
                    ...fakeSoundPaths.map(file => fetch(file))
                ]);

                const arrayBuffers = await Promise.all(responses.map(res => res.arrayBuffer()));
                const decodedAudios = await Promise.all(arrayBuffers.map(ab => audioContext.decodeAudioData(ab)));

                audioBuffer = decodedAudios[0];
                sf6ImpactSoundBuffer = decodedAudios[1];
                flyingAudioBuffer = decodedAudios[2];
                state2EntrySoundBuffer = decodedAudios[3];
                fakeAudioBuffers = decodedAudios.slice(4);

            } catch (e) {
                console.error('Audio loading failed:', e);
                startButton.textContent = 'Audio failed to load';
                return false;
            } finally {
                startButton.disabled = false;
                startButton.textContent = 'start';
            }
            
            return true;
        }

        // éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
        function playSound(buffer) {
            if (!audioContext || !buffer) return null;
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start(0);
            return source;
        }

        // çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        function setState(state, params = {}) {
            state1.style.display = 'none';
            state2.style.display = 'none';
            state3.style.display = 'none';
            tweetButton.style.display = 'none'; // çŠ¶æ…‹åˆ‡æ›¿æ™‚ã«ãƒ„ã‚¤ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º

            if (state === 1) {
                trainingStatus = 'idle';
                state1.style.display = 'block';
            } else if (state === 2) {
                if (params.skipEntrySound !== true) {
                    playSound(state2EntrySoundBuffer);
                }
                state2.style.display = 'block';
                startTraining();
            } else if (state === 3) {
                trainingStatus = 'idle';
                state3.style.display = 'block';

                // å¤±æ•—éŸ³ã‚’å†ç”Ÿ
                if (params.playFailSound) {
                    playSound(flyingAudioBuffer);
                }

                // æˆåŠŸæ™‚ã®ã¿ãƒ„ã‚¤ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆãƒ»è¡¨ç¤º
                if (params.success) {
                    const { elapsedTime, elapsedFrames, isFakeModeChecked } = params.result;
                    const text = `ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã‚’éŸ³ã§èã„ã¦ ${elapsedTime.toFixed(2)}ms (${elapsedFrames.toFixed(2)}F) ã§è¿”ã—ã¾ã—ãŸï¼`;
                    let hashtags = 'ãŠã˜æ•™æˆã®éŸ³å£°ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆè¿”ã—ç‰¹è¨“ã‚¢ãƒ—ãƒª';
                    if (isFakeModeChecked) {
                        hashtags += ',ãƒ•ã‚§ã‚¤ã‚¯ã‚ã‚Š';
                    }
                    const url = window.location.href;
                    tweetButton.href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&hashtags=${encodeURIComponent(hashtags)}&url=${encodeURIComponent(url)}`;
                    tweetButton.style.display = 'inline-block';
                }
            }
        }

        // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹å‡¦ç†
        function startTraining() {
            clearTimeout(timer);
            clearTimeout(timeoutTimer); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¿ã‚¤ãƒãƒ¼ã‚‚ã‚¯ãƒªã‚¢
            if (activeAudioSource) {
                activeAudioSource.onended = null;
                activeAudioSource.stop();
                activeAudioSource = null;
            }
            startTime = undefined;
            trainingStatus = 'waiting';

            const randomTime = Math.random() * 10000 + 5000;

            // å†ç”Ÿã™ã‚‹ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆéŸ³ã®ãƒãƒƒãƒ•ã‚¡ã‚’é¸æŠ
            const impactSoundToPlay = useOldImpactSound ? audioBuffer : sf6ImpactSoundBuffer;

            if (!fakeModeCheckbox.checked) {
                // ãƒ•ã‚§ã‚¤ã‚¯ãªã—ãƒ¢ãƒ¼ãƒ‰ (å¸¸ã«é€šå¸¸ãƒ¢ãƒ¼ãƒ‰)
                currentMode = 'normal';
                timer = setTimeout(() => {
                    trainingStatus = 'playing';
                    activeAudioSource = playSound(impactSoundToPlay);
                    startTime = performance.now();

                    // 3ç§’å¾Œã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’è¨­å®š
                    timeoutTimer = setTimeout(() => {
                        resultText.style.color = 'red';
                        resultMessage.textContent = 'åå¿œãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å¤±æ•—ã€‚ / No reaction. Failed.';
                        resultMessage.style.color = 'red';
                        resultTimeMs.textContent = 'N/A';
                        resultTimeFrames.textContent = 'N/A';
                        setState(3, { success: false, playFailSound: true });
                    }, 3000);
                }, randomTime);
            } else {
                // ãƒ•ã‚§ã‚¤ã‚¯ã‚ã‚Šãƒ¢ãƒ¼ãƒ‰ (ç¾åœ¨ã®50%åˆ†å²ãƒ­ã‚¸ãƒƒã‚¯)
                if (Math.random() < 0.5) {
                    currentMode = 'normal';
                    timer = setTimeout(() => {
                        trainingStatus = 'playing';
                        activeAudioSource = playSound(impactSoundToPlay);
                        startTime = performance.now();

                        // 3ç§’å¾Œã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’è¨­å®š
                        timeoutTimer = setTimeout(() => {
                            resultText.style.color = 'red';
                            resultMessage.textContent = 'åå¿œãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å¤±æ•—ã€‚ / No reaction. Failed.';
                            resultMessage.style.color = 'red';
                            resultTimeMs.textContent = 'N/A';
                            resultTimeFrames.textContent = 'N/A';
                            setState(3, { success: false, playFailSound: true });
                        }, 3000);
                    }, randomTime);
                } else {
                    currentMode = 'fake';
                    timer = setTimeout(() => {
                        trainingStatus = 'playing';
                        const fakeSound = fakeAudioBuffers[Math.floor(Math.random() * fakeAudioBuffers.length)];
                        activeAudioSource = playSound(fakeSound);
                        activeAudioSource.onended = () => {
                            trainingStatus = 'idle';
                            setTimeout(() => setState(2, { skipEntrySound: true }), 100); // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æ¬¡ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¸
                        };
                    }, randomTime);
                }
            }
        }

        // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        startButton.addEventListener('click', async () => {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            const audioReady = await setupAudio();
            if (audioReady) {
                setState(2);
            }
        });

        // ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        impactButton.addEventListener('mousedown', () => {
            if (trainingStatus === 'waiting') {
                // ãƒ•ãƒ©ã‚¤ãƒ³ã‚°
                playSound(flyingAudioBuffer);
                clearTimeout(timer);
                resultText.style.color = 'red';
                resultMessage.textContent = 'ãƒ•ãƒ©ã‚¤ãƒ³ã‚°ã§å¤±æ•— / Failed by flying.';
                resultMessage.style.color = 'red';
                resultTimeMs.textContent = 'N/A';
                resultTimeFrames.textContent = 'N/A';
                setState(3, { success: false });
                return;
            }

            if (trainingStatus === 'playing') {
                if (currentMode === 'fake') {
                    // ãƒ•ã‚§ã‚¤ã‚¯éŸ³ã«å¯¾ã—ã¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸå ´åˆ
                    playSound(flyingAudioBuffer);
                    if (activeAudioSource) {
                        activeAudioSource.onended = null;
                        activeAudioSource.stop();
                    }
                    resultText.style.color = 'red';
                    resultMessage.textContent = 'ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆéŸ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å¤±æ•—ã€‚ / Not a drive impact sound. Failed.';
                    resultMessage.style.color = 'red';
                    resultTimeMs.textContent = 'N/A';
                    resultTimeFrames.textContent = 'N/A';
                    setState(3, { success: false });
                    return;
                }

                if (currentMode === 'normal') {
                    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã®æ­£å¸¸ãªåå¿œ
                    clearTimeout(timeoutTimer); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    if (startTime === undefined) return; // å®‰å…¨ç­–

                    const endTime = performance.now();
                    const elapsedTime = endTime - startTime;
                    const elapsedFrames = elapsedTime / (1000 / 60);

                    resultTimeMs.textContent = elapsedTime.toFixed(2);
                    resultTimeFrames.textContent = elapsedFrames.toFixed(2);

                    if (elapsedFrames >= 25) {
                        playSound(flyingAudioBuffer);
                        resultText.style.color = 'red';
                        resultMessage.textContent = 'ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆè¿”ã—å¤±æ•— / Failed.';
                        resultMessage.style.color = 'red';
                        setState(3, { success: false, playFailSound: true });
                    } else {
                        resultText.style.color = 'blue';
                        resultMessage.textContent = 'ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆè¿”ã—æˆåŠŸ / Succeeded.';
                        resultMessage.style.color = 'blue';
                        setState(3, { success: true, result: { elapsedTime, elapsedFrames } });
                    }
                    
                    startTime = undefined;
                }
            }
            // trainingStatusãŒ'idle'ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
        });;

        // ã‚‚ã†ä¸€åº¦ã‚„ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        retryButton.addEventListener('click', () => {
            setState(2);
        });

        // ã‚²ãƒ¼ãƒ ãƒ‘ãƒƒãƒ‰ã®ãƒ«ãƒ¼ãƒ—å‡¦ç†
        function gamepadLoop() {
            const gamepads = navigator.getGamepads();
            for (let i = 0; i < gamepads.length; i++) {
                const gamepad = gamepads[i];
                if (gamepad) {
                    gamepad.buttons.forEach((button, buttonIndex) => {
                        const buttonId = `${gamepad.index}-${buttonIndex}`;
                        const isPressed = button.pressed;
                        const wasPressed = prevGamepadButtons[buttonId] || false;

                        if (isPressed && !wasPressed) {
                            // ç¾åœ¨ã®è¡¨ç¤ºçŠ¶æ…‹ã«å¿œã˜ã¦ã€å¯¾å¿œã™ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
                            if (state1.style.display === 'block') {
                                startButton.click();
                            } else if (state2.style.display === 'block') {
                                impactButton.click();
                            } else if (state3.style.display === 'block') {
                                retryButton.click();
                            }
                        }
                        prevGamepadButtons[buttonId] = isPressed;
                    });
                }
            }
            requestAnimationFrame(gamepadLoop);
        }

        // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
        setState(1);
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è§£æ
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('o') === '1') {
            useOldImpactSound = true;
        }
        // ã‚²ãƒ¼ãƒ ãƒ‘ãƒƒãƒ‰ã®ç›£è¦–ã‚’é–‹å§‹
        gamepadLoop();
    </script>
    <footer class="text-center mt-5 py-3">
        <a href="https://www.youtube.com/@qurihara" target="_blank" rel="noopener noreferrer">&copy; Kazutaka Kurihara</a><br>
        <a href="https://github.com/qurihara/DIR_training" target="_blank" rel="noopener noreferrer">GitHub Repository</a>
    </footer>
</body>
</html>
