<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impact Reversal Training by Sound</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .impact-button {
            width: 100%;
            height: 300px;
            font-size: 2rem;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Drive Impact Reversal Training by Sound v1.05</h1>

        <!-- çŠ¶æ…‹1: åˆæœŸç”»é¢ -->
        <div id="state1">
            <h2>éŸ³ã§ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã‚’è¿”ã™ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h2>
            <button id="startButton" class="btn btn-primary impact-button">start</button>
            <h5>ï¼ˆiPhoneã ã¨éŸ³ã®å†ç”ŸãŒé…ã„ã¿ãŸã„ã§ã™ã€‚å¾Œã»ã©ä¿®æ­£ã—ã¾ã™ğŸ™ï¼‰</h2>
            </div>

        <!-- çŠ¶æ…‹2: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”»é¢ -->
        <div id="state2" style="display: none;">
            <p>ãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã®éŸ³ãŒé³´ã£ãŸã‚‰ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä¸‹ã•ã„ã€‚ / Push the button when the drive impact sound is played.</p>
            <button id="impactButton" class="btn btn-danger impact-button">ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãƒœã‚¿ãƒ³ / Impact button</button>
        </div>

        <!-- çŠ¶æ…‹3: çµæœç”»é¢ -->
        <div id="state3" style="display: none;">
            <h3>çµæœ</h3>
            <div id="resultText">
                <p>çµŒéæ™‚é–“ / Elapsed Time: <span id="resultTimeMs"></span> ms</p>
                <p>ãƒ•ãƒ¬ãƒ¼ãƒ  / Frames: <span id="resultTimeFrames"></span> frames (60fps)</p>
            </div>
            <h4 id="resultMessage" class="mt-3"></h4>
            <button id="retryButton" class="btn btn-primary mt-3">ã‚‚ã†ä¸€åº¦ã‚„ã‚‹</button>
        </div>
    </div>

    <audio id="impactSound" src="B.wav" preload="auto"></audio>

    <script>
        const state1 = document.getElementById('state1');
        const state2 = document.getElementById('state2');
        const state3 = document.getElementById('state3');

        const startButton = document.getElementById('startButton');
        const impactButton = document.getElementById('impactButton');
        const retryButton = document.getElementById('retryButton');

        const impactSound = document.getElementById('impactSound');
        const resultTimeMs = document.getElementById('resultTimeMs');
        const resultTimeFrames = document.getElementById('resultTimeFrames');
        const resultText = document.getElementById('resultText');
        const resultMessage = document.getElementById('resultMessage');

        let startTime;
        let timer;

        // çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        function setState(state) {
            state1.style.display = 'none';
            state2.style.display = 'none';
            state3.style.display = 'none';

            if (state === 1) {
                state1.style.display = 'block';
            } else if (state === 2) {
                state2.style.display = 'block';
                impactButton.disabled = true; // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                startTraining();
            } else if (state === 3) {
                state3.style.display = 'block';
            }
        }

        // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹å‡¦ç†
        function startTraining() {
            const randomTime = Math.random() * 10000 + 5000; // 5ç§’ã‹ã‚‰15ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ™‚é–“
            
            timer = setTimeout(() => {
                impactSound.currentTime = 0;
                impactSound.play();
                startTime = performance.now();
                impactButton.disabled = false; // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            }, randomTime);
        }

        // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        startButton.addEventListener('click', () => {
            // iOS Safariã®éŸ³å£°å†ç”Ÿåˆ¶é™ã‚’å›é¿ã™ã‚‹ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œæ™‚ã«ä¸€åº¦å†ç”Ÿã‚’è©¦ã¿ã‚‹
            impactSound.play();
            impactSound.pause();
            impactSound.currentTime = 0;

            setState(2);
        });

        // ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        impactButton.addEventListener('click', () => {
            // ã‚¿ã‚¤ãƒãƒ¼ãŒä½œå‹•ã™ã‚‹å‰ã«ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã‚’è€ƒæ…®
            if (startTime === undefined) return;

            const endTime = performance.now();
            const elapsedTime = endTime - startTime;
            const elapsedFrames = elapsedTime / (1000 / 60);

            resultTimeMs.textContent = elapsedTime.toFixed(2);
            resultTimeFrames.textContent = elapsedFrames.toFixed(2);

            if (elapsedFrames >= 27) {
                resultText.style.color = 'red';
                resultMessage.textContent = 'ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆè¿”ã—å¤±æ•— / Failed. â€»éŸ³ã®é³´ã‚Šå§‹ã‚ã‹ã‚‰è¨ˆæ¸¬ã—ã¦ã„ã‚‹ã®ã§ã€å®Ÿéš›ã®æˆåŠŸåˆ¤å®šã¨ã¯ç•°ãªã‚Šã¾ã™ã€‚';
                resultMessage.style.color = 'red';
            } else {
                resultText.style.color = 'blue';
                resultMessage.textContent = 'ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆè¿”ã—æˆåŠŸ / Succeeded.';
                resultMessage.style.color = 'blue';
            }
            
            // startTimeã‚’ãƒªã‚»ãƒƒãƒˆ
            startTime = undefined;

            setState(3);
        });

        // ã‚‚ã†ä¸€åº¦ã‚„ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        retryButton.addEventListener('click', () => {
            setState(2);
        });

        // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
        setState(1);
    </script>
    <footer class="text-center mt-5 py-3">
        <a href="https://www.youtube.com/@qurihara" target="_blank" rel="noopener noreferrer">&copy; Kazutaka Kurihara</a>
    </footer>
</body>
</html>
